---
title: "Configuration"
description: "Configure Conductor with wrangler.toml"
---

## Overview

Configure your Conductor deployment using `wrangler.toml`, the configuration file for Cloudflare Workers. This guide covers all configuration options for running Conductor workflows at the edge.

## Basic Configuration

### Minimal Setup

```toml
name = "my-conductor-app"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[ai]
binding = "AI"
```

### Complete Setup

```toml
name = "my-conductor-app"
main = "src/index.ts"
compatibility_date = "2024-01-01"
workers_dev = true

# Ensemble directory
[observability]
enabled = true

# AI binding
[ai]
binding = "AI"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "production-db"
database_id = "your-database-id"

# KV Namespace
[[kv_namespaces]]
binding = "CACHE"
id = "your-kv-id"

# R2 Bucket
[[r2_buckets]]
binding = "ASSETS"
bucket_name = "conductor-assets"

# Vectorize Index
[[vectorize]]
binding = "VECTORIZE"
index_name = "embeddings"

# Durable Objects
[[durable_objects.bindings]]
name = "EXECUTION_STATE"
class_name = "ExecutionState"
script_name = "my-conductor-app"

[[durable_objects.bindings]]
name = "HITL_STATE"
class_name = "HITLState"
script_name = "my-conductor-app"

[[migrations]]
tag = "v1"
new_classes = ["ExecutionState", "HITLState"]

# Queue
[[queues.producers]]
binding = "TASK_QUEUE"
queue = "conductor-tasks"

[[queues.consumers]]
queue = "conductor-tasks"
max_batch_size = 10
max_batch_timeout = 30
```

## Configuration Sections

### Worker Settings

```toml
name = "my-conductor-app"           # Worker name (required)
main = "src/index.ts"               # Entry point (required)
compatibility_date = "2024-01-01"   # Compatibility date (required)
workers_dev = true                  # Enable dev mode
node_compat = true                  # Enable Node.js compatibility
```

**Compatibility Date**: Use a recent date to get latest features. See [Cloudflare compatibility dates](https://developers.cloudflare.com/workers/platform/compatibility-dates/).

### AI Binding

```toml
[ai]
binding = "AI"  # Environment variable name for Workers AI
```

Access in code:
```typescript
const conductor = new Conductor({
  env: {
    AI: env.AI  // Cloudflare Workers AI binding
  }
});
```

### Database (D1)

```toml
[[d1_databases]]
binding = "DB"                    # Environment variable name
database_name = "production-db"   # Database name
database_id = "abc123"            # Database ID from dashboard
```

Create database:
```bash
npx wrangler d1 create production-db
# Copy database_id from output
```

### KV Storage

```toml
[[kv_namespaces]]
binding = "CACHE"     # Environment variable name
id = "abc123"         # KV namespace ID
preview_id = "xyz789" # Preview namespace (optional)
```

Create namespace:
```bash
npx wrangler kv:namespace create CACHE
# Copy id from output
```

### R2 Storage

```toml
[[r2_buckets]]
binding = "ASSETS"           # Environment variable name
bucket_name = "my-assets"    # Bucket name
preview_bucket_name = "dev"  # Preview bucket (optional)
```

Create bucket:
```bash
npx wrangler r2 bucket create my-assets
```

### Vectorize

```toml
[[vectorize]]
binding = "VECTORIZE"      # Environment variable name
index_name = "embeddings"  # Index name
```

Create index:
```bash
npx wrangler vectorize create embeddings --dimensions=1536 --metric=cosine
```

### Durable Objects

```toml
[[durable_objects.bindings]]
name = "EXECUTION_STATE"           # Binding name
class_name = "ExecutionState"      # Class exported from worker
script_name = "my-conductor-app"   # Worker name

[[durable_objects.bindings]]
name = "HITL_STATE"
class_name = "HITLState"
script_name = "my-conductor-app"

# Migrations (required for DO)
[[migrations]]
tag = "v1"                                    # Migration version
new_classes = ["ExecutionState", "HITLState"] # Classes to register
```

Export classes in your worker:
```typescript
export { ExecutionState } from '@ensemble-edge/conductor/durable-objects';
export { HITLState } from '@ensemble-edge/conductor/durable-objects';
```

### Queues

```toml
# Producer (send messages)
[[queues.producers]]
binding = "TASK_QUEUE"
queue = "conductor-tasks"

# Consumer (receive messages)
[[queues.consumers]]
queue = "conductor-tasks"
max_batch_size = 10       # Max messages per batch
max_batch_timeout = 30    # Max seconds to wait
max_retries = 3           # Retry failed messages
dead_letter_queue = "dlq" # Dead letter queue name
```

Create queue:
```bash
npx wrangler queues create conductor-tasks
```

## Environment Configuration

### Multiple Environments

```toml
# Development
[env.dev]
name = "conductor-dev"
vars = { ENVIRONMENT = "development" }

[[env.dev.d1_databases]]
binding = "DB"
database_name = "dev-db"
database_id = "dev-id"

# Staging
[env.staging]
name = "conductor-staging"
vars = { ENVIRONMENT = "staging" }

[[env.staging.d1_databases]]
binding = "DB"
database_name = "staging-db"
database_id = "staging-id"

# Production
[env.production]
name = "conductor-production"
vars = { ENVIRONMENT = "production" }

[[env.production.d1_databases]]
binding = "DB"
database_name = "production-db"
database_id = "prod-id"
```

Deploy to specific environment:
```bash
npx wrangler deploy --env production
```

### Environment Variables

```toml
[vars]
ENVIRONMENT = "production"
LOG_LEVEL = "info"
MAX_RETRIES = "3"
```

Access in code:
```typescript
console.log(`Environment: ${env.ENVIRONMENT}`);
```

**Note**: Use `vars` for non-sensitive configuration. For secrets (API keys, tokens), use [Secrets Management](/conductor/guides/secrets-management).

## Resource Limits

### Worker Limits

```toml
# CPU time limit (default: 50ms on free plan, unlimited on paid)
# Memory limit: 128MB
# Request size limit: 100MB
# Response size limit: 100MB

[limits]
cpu_ms = 50  # Only affects billing, not hard limit on paid plans
```

### D1 Limits

- Max database size: 10GB (can request increase)
- Max rows per table: No limit
- Max query execution time: 30 seconds
- Max queries per request: 50

### KV Limits

- Max key size: 512 bytes
- Max value size: 25MB
- Max metadata size: 1KB
- Read operations: 100,000 per day (free), unlimited (paid)
- Write operations: 1,000 per day (free), unlimited (paid)

### R2 Limits

- Max object size: 5TB
- Max multipart upload: 10,000 parts
- Storage: 10GB free, then pay-as-you-go

### Vectorize Limits

- Max dimensions: 1536
- Max vectors per index: 5 million (can request increase)
- Max queries per second: 1,000

## Custom Routes

### Route Patterns

```toml
routes = [
  { pattern = "api.example.com/*", zone_name = "example.com" },
  { pattern = "example.com/api/*", zone_name = "example.com" }
]
```

### Custom Domains

```toml
routes = [
  { pattern = "conductor.example.com/*", custom_domain = true }
]
```

## Build Configuration

### TypeScript

```toml
[build]
command = "npm run build"

[build.upload]
format = "service-worker"
```

### ESBuild Options

```toml
[build.upload]
format = "modules"
dir = "dist"
main = "./index.js"

[[build.upload.rules]]
type = "Text"
globs = ["**/*.txt"]

[[build.upload.rules]]
type = "Data"
globs = ["**/*.bin"]
```

## Observability

### Logpush

```toml
[observability]
enabled = true
```

### Tail Workers

```toml
[tail_consumers]
service = "my-tail-worker"
environment = "production"
```

## Routing Configuration

### UnifiedRouter Setup

Conductor includes a powerful UnifiedRouter for managing authentication and routing across all members. Configuration is managed via `conductor.config.ts`:

```typescript
// conductor.config.ts
import type { ConductorConfig } from '@ensemble-edge/conductor';

const config: ConductorConfig = {
  routing: {
    auth: {
      // Global defaults (apply to all routes)
      global: {
        requirement: 'required',
        methods: ['bearer']
      },

      // Type-specific defaults
      defaults: {
        pages: {
          requirement: 'required',
          methods: ['cookie'],
          onFailure: {
            action: 'redirect',
            redirectTo: '/login',
            preserveReturn: true
          }
        },
        api: {
          requirement: 'required',
          methods: ['bearer', 'apiKey']
        },
        webhooks: {
          requirement: 'required',
          methods: ['custom']
        },
        docs: {
          requirement: 'public'
        }
      },

      // Path-based rules (override type defaults)
      rules: [
        // Public routes
        { pattern: '/', auth: { requirement: 'public' } },
        { pattern: '/login', auth: { requirement: 'public' } },
        { pattern: '/signup', auth: { requirement: 'public' } },

        // Admin routes
        {
          pattern: '/admin/*',
          auth: {
            requirement: 'required',
            methods: ['cookie', 'bearer'],
            roles: ['admin'],
            onFailure: {
              action: 'page',
              page: 'error-403'
            }
          },
          priority: 10
        },

        // API routes with rate limiting
        {
          pattern: '/api/public/*',
          auth: {
            requirement: 'public',
            rateLimit: {
              requests: 1000,
              window: 3600,
              keyBy: 'ip'
            }
          }
        }
      ],

      // Custom webhook validators
      customValidators: {
        stripe: {
          type: 'stripe',
          secretEnvVar: 'STRIPE_WEBHOOK_SECRET',
          tolerance: 300
        },
        github: {
          type: 'github',
          secretEnvVar: 'GITHUB_WEBHOOK_SECRET'
        }
      }
    }
  }
};

export default config;
```

### Authentication Methods

Configure authentication methods with environment variables:

#### Bearer Token (JWT)

```toml
[vars]
JWT_SECRET = "your-secret-key-min-32-chars"
JWT_ISSUER = "https://your-domain.com"
JWT_AUDIENCE = "https://api.your-domain.com"
```

**Important**: Use `npx wrangler secret put JWT_SECRET` for production secrets, not `vars`.

#### API Key (KV Storage)

```toml
[[kv_namespaces]]
binding = "API_KEYS"
id = "your-api-keys-kv-id"

[vars]
API_KEY_KV_NAMESPACE = "API_KEYS"
API_KEY_HEADER = "X-API-Key"
```

Create KV namespace:
```bash
npx wrangler kv:namespace create API_KEYS
```

#### Cookie Session (KV Storage)

```toml
[[kv_namespaces]]
binding = "SESSIONS"
id = "your-sessions-kv-id"

[vars]
SESSION_KV_NAMESPACE = "SESSIONS"
SESSION_COOKIE_NAME = "__session"
SESSION_DOMAIN = ".example.com"
SESSION_MAX_AGE = "86400"  # 24 hours
```

Set session secret:
```bash
npx wrangler secret put SESSION_SECRET
```

#### Unkey Integration

```bash
# Set via secrets (recommended)
npx wrangler secret put UNKEY_ROOT_KEY
npx wrangler secret put UNKEY_API_ID
```

#### Custom Validators (Webhooks)

```bash
# Stripe webhooks
npx wrangler secret put STRIPE_WEBHOOK_SECRET

# GitHub webhooks
npx wrangler secret put GITHUB_WEBHOOK_SECRET

# Twilio webhooks
npx wrangler secret put TWILIO_AUTH_TOKEN
```

### Route Configuration in Members

Members can specify routes with authentication:

**Page Member** (`pages/dashboard/page.yaml`):
```yaml
name: dashboard
type: page
description: User dashboard

route:
  path: /dashboard  # or use "default" for auto-resolution
  methods: [GET]
  auth:
    requirement: required
    methods: [cookie]
    onFailure:
      action: redirect
      redirectTo: /login
```

**API Member** (`members/users-api.yaml`):
```yaml
name: users-api
type: api
description: User management API

route:
  path: /api/users
  methods: [GET, POST]
  auth:
    requirement: required
    methods: [bearer, apiKey]
    permissions: [users:read, users:write]
```

**Docs Member** (`members/api-docs.yaml`):
```yaml
name: api-docs
type: docs
description: API documentation

route:
  path: default  # Auto-resolves to /api-docs
  auth:
    requirement: optional  # View without auth, test with auth
    methods: [bearer, apiKey, cookie]
```

**Webhook Member** (`members/stripe-webhook.yaml`):
```yaml
name: stripe-webhook
type: webhook
description: Stripe payment webhooks

route:
  path: /webhooks/stripe
  methods: [POST]
  auth:
    requirement: required
    methods: [custom]
    customValidator: stripe  # Uses config from conductor.config.ts
```

### Default Path Resolution

Use `route: default` to automatically resolve the path from the file location:

| File Path | Resolved Route |
|-----------|---------------|
| `pages/login/page.yaml` | `/login` |
| `pages/admin/dashboard/page.yaml` | `/admin/dashboard` |
| `pages/index/page.yaml` | `/` |
| `members/api-docs.yaml` | `/api-docs` |

### Priority-Based Routing

Routes are matched by priority (lower number = higher priority):

| Member Type | Default Priority |
|-------------|-----------------|
| Static | 1 |
| Health | 5 |
| Auth | 10 |
| API | 30 |
| Webhooks | 40 |
| Forms | 50 |
| Docs | 70 |
| Pages | 90 |

Override with explicit priority:
```yaml
route:
  path: /admin/dashboard
  priority: 10  # Higher priority than default page routes
```

### Complete Configuration Example

```toml
# wrangler.toml
name = "conductor-app"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# AI binding
[ai]
binding = "AI"

# Authentication KV namespaces
[[kv_namespaces]]
binding = "API_KEYS"
id = "your-api-keys-id"

[[kv_namespaces]]
binding = "SESSIONS"
id = "your-sessions-id"

# Configuration variables
[vars]
ENVIRONMENT = "production"
API_KEY_KV_NAMESPACE = "API_KEYS"
SESSION_KV_NAMESPACE = "SESSIONS"
SESSION_COOKIE_NAME = "__session"
SESSION_DOMAIN = ".example.com"
SESSION_MAX_AGE = "86400"
JWT_ISSUER = "https://example.com"
JWT_AUDIENCE = "https://api.example.com"

# Secrets (set with: npx wrangler secret put SECRET_NAME)
# - JWT_SECRET
# - SESSION_SECRET
# - STRIPE_WEBHOOK_SECRET
# - GITHUB_WEBHOOK_SECRET
# - UNKEY_ROOT_KEY
# - UNKEY_API_ID
```

## Cron Triggers

```toml
[triggers]
crons = [
  "0 0 * * *",      # Daily at midnight
  "*/15 * * * *",   # Every 15 minutes
  "0 9 * * 1-5"     # Weekdays at 9am
]
```

Access in worker:
```typescript
export default {
  async scheduled(event: ScheduledEvent, env: Env): Promise<void> {
    const conductor = new Conductor({ env });
    await conductor.executeEnsemble('daily-report', {
      date: new Date().toISOString()
    });
  }
};
```

## Best Practices

1. **Use compatibility dates** - Keep up to date with latest features
2. **Separate environments** - dev, staging, production
3. **Don't commit secrets** - Use `wrangler secret` for sensitive data
4. **Test locally first** - Use `wrangler dev` before deploying
5. **Monitor limits** - Track resource usage in dashboard
6. **Version migrations** - Increment migration tags for DO changes
7. **Use preview bindings** - Separate dev/production data
8. **Document configuration** - Add comments explaining settings
9. **Backup data** - Regular backups of D1 databases
10. **Review costs** - Monitor usage and optimize

## Validation

### Check Configuration

```bash
# Validate syntax
npx wrangler deploy --dry-run

# List bindings
npx wrangler deployments list

# Check resource IDs
npx wrangler d1 list
npx wrangler kv:namespace list
npx wrangler r2 bucket list
npx wrangler vectorize list
```

### Common Issues

**Missing binding error**:
```
Error: No D1 database with binding 'DB'
```
Solution: Add D1 binding to wrangler.toml

**Compatibility date error**:
```
Error: compatibility_date is too old
```
Solution: Update to recent date (within last 6 months)

**Durable Object not found**:
```
Error: Class 'ExecutionState' not found
```
Solution: Add migration and export class

## Migration Example

### From v0.x to v1.0

```toml
# Before (v0.x)
name = "conductor-app"
type = "javascript"
account_id = "abc123"

# After (v1.0)
name = "conductor-app"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[ai]
binding = "AI"
```

## Related Documentation

<CardGroup cols={2}>
  <Card
    title="Environment Variables"
    icon="key"
    href="/conductor/deployment/environment-variables"
  >
    Manage environment variables
  </Card>

  <Card
    title="Bindings"
    icon="link"
    href="/conductor/deployment/bindings"
  >
    Configure resource bindings
  </Card>

  <Card
    title="Secrets Management"
    icon="lock"
    href="/conductor/guides/secrets-management"
  >
    Secure API keys and tokens
  </Card>

  <Card
    title="Wrangler Docs"
    icon="book"
    href="https://developers.cloudflare.com/workers/wrangler/configuration/"
  >
    Official Cloudflare documentation
  </Card>
</CardGroup>
