---
title: "Provider Registry"
description: "Managing and extending the AI provider registry"
---

## Overview

The Provider Registry manages all AI provider instances in Conductor. It uses a singleton pattern to provide global access to registered providers and makes it easy to add custom providers without modifying existing code.

```typescript
import { getProviderRegistry } from '@ensemble-edge/conductor';

const registry = getProviderRegistry();

// Get provider
const anthropic = registry.get('anthropic');

// List all providers
const providers = registry.getAllProviders();
console.log(providers.map(p => p.name));
// ['OpenAI', 'Anthropic', 'Cloudflare Workers AI', 'Custom']
```

## API Reference

### ProviderRegistry

Main registry class for managing AI providers.

#### constructor()

Creates a new registry and registers default providers:

```typescript
const registry = new ProviderRegistry();
```

Default providers:
- OpenAI
- Anthropic
- Cloudflare Workers AI
- Custom

#### register()

Register a custom provider:

```typescript
register(provider: AIProvider): void
```

<ParamField path="provider" type="AIProvider" required>
  Provider instance to register
</ParamField>

**Example**:

```typescript
import { ProviderRegistry } from '@ensemble-edge/conductor';
import { CustomAIProvider } from './my-provider';

const registry = new ProviderRegistry();
const myProvider = new CustomAIProvider();

registry.register(myProvider);
```

#### get()

Get provider by ID:

```typescript
get(providerId: string): AIProvider | null
```

<ParamField path="providerId" type="string" required>
  Provider identifier (e.g., 'anthropic', 'openai')
</ParamField>

**Returns**: `AIProvider | null`

**Example**:

```typescript
const provider = registry.get('anthropic');

if (provider) {
  console.log(provider.name); // 'Anthropic'
  const response = await provider.execute(request);
}
```

#### has()

Check if provider exists:

```typescript
has(providerId: string): boolean
```

**Example**:

```typescript
if (registry.has('anthropic')) {
  console.log('Anthropic provider available');
}
```

#### getProviderIds()

Get all registered provider IDs:

```typescript
getProviderIds(): string[]
```

**Example**:

```typescript
const ids = registry.getProviderIds();
console.log(ids);
// ['openai', 'anthropic', 'cloudflare', 'custom']
```

#### getAllProviders()

Get all registered provider instances:

```typescript
getAllProviders(): AIProvider[]
```

**Example**:

```typescript
const providers = registry.getAllProviders();

for (const provider of providers) {
  console.log(`${provider.name} (${provider.id})`);
}
```

## Global Registry

### getProviderRegistry()

Get the global singleton registry:

```typescript
function getProviderRegistry(): ProviderRegistry
```

**Example**:

```typescript
import { getProviderRegistry } from '@ensemble-edge/conductor';

const registry = getProviderRegistry();
const provider = registry.get('anthropic');
```

### resetProviderRegistry()

Reset the global registry (useful for testing):

```typescript
function resetProviderRegistry(): void
```

**Example**:

```typescript
import { resetProviderRegistry } from '@ensemble-edge/conductor';

// In test setup
beforeEach(() => {
  resetProviderRegistry();
});
```

## Creating Custom Providers

### AIProvider Interface

All providers must implement:

```typescript
interface AIProvider {
  readonly id: ProviderId;
  readonly name: string;
  
  execute(request: AIProviderRequest): Promise<AIProviderResponse>;
  validateConfig(config: AIProviderConfig, env: Env): boolean;
  getConfigError(config: AIProviderConfig, env: Env): string | null;
}
```

### BaseAIProvider

Extend the base class for common functionality:

```typescript
import { BaseAIProvider } from '@ensemble-edge/conductor';
import type {
  AIProviderRequest,
  AIProviderResponse,
  AIProviderConfig
} from '@ensemble-edge/conductor';

export class MyCustomProvider extends BaseAIProvider {
  readonly id = 'my-provider' as ProviderId;
  readonly name = 'My Custom Provider';
  
  async execute(request: AIProviderRequest): Promise<AIProviderResponse> {
    const { messages, config, env } = request;
    
    // Get API key
    const apiKey = this.getApiKey(config, env, 'MY_PROVIDER_API_KEY');
    
    // Make request
    const response = await this.makeRequest(
      config.apiEndpoint || 'https://api.myprovider.com/v1/chat',
      { 'Authorization': `Bearer ${apiKey}` },
      {
        model: config.model,
        messages,
        temperature: config.temperature,
        max_tokens: config.maxTokens
      }
    );
    
    return {
      content: response.choices[0].message.content,
      model: config.model,
      tokensUsed: response.usage.total_tokens,
      provider: this.id,
      metadata: { raw: response }
    };
  }
  
  getConfigError(config: AIProviderConfig, env: Env): string | null {
    const apiKey = this.getApiKey(config, env, 'MY_PROVIDER_API_KEY');
    
    if (!apiKey) {
      return 'MY_PROVIDER_API_KEY not found in environment';
    }
    
    if (!config.model) {
      return 'Model is required for My Custom Provider';
    }
    
    return null;
  }
}
```

### Register Custom Provider

```typescript
import { getProviderRegistry } from '@ensemble-edge/conductor';
import { MyCustomProvider } from './my-provider';

// Get global registry
const registry = getProviderRegistry();

// Register custom provider
registry.register(new MyCustomProvider());

// Now available in ensembles
```

Use in ensemble:

```yaml
- member: use-custom-provider
  type: Think
  config:
    provider: my-provider
    model: my-model-v1
  input:
    prompt: Generate content
```

## Testing with Custom Providers

### Mock Provider

Create a mock provider for testing:

```typescript
import { BaseAIProvider } from '@ensemble-edge/conductor';

export class MockProvider extends BaseAIProvider {
  readonly id = 'mock' as ProviderId;
  readonly name = 'Mock Provider';
  
  private responses: Map<string, string> = new Map();
  
  setResponse(prompt: string, response: string) {
    this.responses.set(prompt, response);
  }
  
  async execute(request: AIProviderRequest): Promise<AIProviderResponse> {
    const lastMessage = request.messages[request.messages.length - 1];
    const response = this.responses.get(lastMessage.content) || 'Mock response';
    
    return {
      content: response,
      model: request.config.model,
      tokensUsed: 10,
      provider: this.id
    };
  }
  
  getConfigError(): string | null {
    return null; // Always valid
  }
}
```

Use in tests:

```typescript
import { resetProviderRegistry, getProviderRegistry } from '@ensemble-edge/conductor';
import { MockProvider } from './mock-provider';

describe('AI workflows', () => {
  let mockProvider: MockProvider;
  
  beforeEach(() => {
    resetProviderRegistry();
    mockProvider = new MockProvider();
    
    const registry = getProviderRegistry();
    registry.register(mockProvider);
  });
  
  it('generates content', async () => {
    mockProvider.setResponse('Generate a title', 'Test Title');
    
    const result = await conductor.execute('generate-content', {
      prompt: 'Generate a title'
    });
    
    expect(result.output.title).toBe('Test Title');
  });
});
```

## Provider Discovery

List available providers at runtime:

```typescript
import { getProviderRegistry } from '@ensemble-edge/conductor';

export default {
  async fetch(request: Request): Promise<Response> {
    const registry = getProviderRegistry();
    
    const providers = registry.getAllProviders().map(p => ({
      id: p.id,
      name: p.name
    }));
    
    return Response.json({ providers });
  }
};
```

Response:

```json
{
  "providers": [
    { "id": "openai", "name": "OpenAI" },
    { "id": "anthropic", "name": "Anthropic" },
    { "id": "cloudflare", "name": "Cloudflare Workers AI" },
    { "id": "custom", "name": "Custom" }
  ]
}
```

## Best Practices

1. **Use singleton registry** - Access via `getProviderRegistry()`
2. **Register at startup** - Register custom providers before execution
3. **Validate configuration** - Implement `getConfigError()` properly
4. **Handle errors gracefully** - Return null for valid configs
5. **Use BaseAIProvider** - Inherit common functionality
6. **Test with mocks** - Create mock providers for testing
7. **Document providers** - Add clear names and IDs
8. **Version providers** - Consider versioning for breaking changes
9. **Monitor usage** - Track which providers are used
10. **Cache instances** - Don't create new providers per request

## Related Documentation

<CardGroup cols={2}>
  <Card
    title="AI Overview"
    icon="brain"
    href="/conductor-api/ai/overview"
  >
    AI provider system overview
  </Card>

  <Card
    title="Model Catalog"
    icon="book"
    href="/conductor-api/ai/catalog"
  >
    Available models
  </Card>

  <Card
    title="Routing"
    icon="route"
    href="/conductor-api/ai/routing"
  >
    Provider routing strategies
  </Card>

  <Card
    title="Think Member"
    icon="cube"
    href="/conductor-api/member-types/think-member"
  >
    Think member API
  </Card>
</CardGroup>
